<!DOCTYPE html>
<html lang="fr">
<head>
  <meta name="robots" content="noarchive, nofollow">
  <meta http-equiv="Cache-Control" content="no-store">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Library</title>
  <style>
    body {
  font-family: 'Segoe UI', sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 0;
  transition: margin-left 0.3s ease;
}

header {
  background-color: #16677c;
  padding: 20px 30px;
  display: flex;
  align-items: center;
  color: white;
  gap: 20px;
}

.logo {
  height: 50px;
  background-color: white;
  padding: 4px;
  border-radius: 6px;
}

header h1 {
  margin: 0;
  font-size: 2.8rem;
  flex-grow: 1;
  text-align: center;
  font-family: 'Playfair Display', serif;
  font-weight: 700;
  letter-spacing: 1.5px;
  color: #ffffff;
  text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.5);
}

.controls {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.controls button,
.controls select {
  background-color: #fdfefe;
  border: none;
  border-radius: 25px;
  padding: 10px 16px;
  color: rgb(22, 103, 124);
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}

.controls button:hover,
.controls select:hover {
  background-color: #97d8e4;
}

.controls button.active {
  background-color: #97d8e4;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
}

.back-btn {
  background-color: #fcfdfd;
  border-radius: 25px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  color: rgb(22, 103, 124);
  text-decoration: none;
  white-space: nowrap;
}

.back-btn:hover {
  background-color: #97d8e4;
}

.search-bar {
  margin: 30px auto 20px;
  max-width: 700px;
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
}

.search-bar input {
  flex-grow: 1;
  padding: 12px 16px;
  border-radius: 25px;
  border: 1px solid #ccc;
  font-size: 16px;
  outline: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

#fileCount {
  font-weight: 600;
  color: #333;
  min-width: 140px;
  text-align: right;
}

.content-wrapper {
  display: flex;
  min-height: calc(100vh - 120px);
}

.sidebar {
  width: 250px;
  background-color: #f8f9fa;
  border-right: 1px solid #ddd;
  flex-shrink: 0;
  padding: 20px;
  overflow-y: auto;
  transition: transform 0.3s ease;
  position: fixed;
  height: calc(100vh - 120px);
  z-index: 100;
  transform: translateX(-100%);
}

.sidebar.active {
  transform: translateX(0);
  position: relative;
}

.main-content {
  flex-grow: 1;
  padding: 20px;
  transition: none;
  margin-left: 0;
  width: 100%;
}

.sidebar.active ~ .main-content {
  margin-left: 0;
  width: calc(100% - 250px);
}

.gallery {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
  transition: none;
}

body.list-view .gallery {
  display: block;
  max-width: 900px;
  margin: 20px auto;
}

.gallery-item {
  position: relative;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  text-align: center;
  cursor: pointer;
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.gallery-item:hover {
  transform: translateY(-2px);
}

body.list-view .gallery-item {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 15px;
  padding: 10px;
  text-align: left;
  height: auto;
}

.gallery-item img {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 8px;
  background: #f5f5f5;
  transition: opacity 0.3s ease;
}

.gallery-item img[loading="lazy"] {
  opacity: 0;
}

.gallery-item img[data-loaded="true"] {
  opacity: 1;
}

.img-placeholder {
  width: 100%;
  height: 150px;
  background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
  background-size: 200% 100%;
  animation: 1.5s shine linear infinite;
  border-radius: 8px;
}

@keyframes shine {
  to {
    background-position-x: -200%;
  }
}

body.list-view .gallery-item img {
  width: 120px;
  height: 80px;
  object-fit: cover;
  flex-shrink: 0;
}

.file-preview {
  padding: 50px 10px;
  font-size: 13px;
  background-color: #f4f4f4;
  color: #555;
  border-radius: 8px;
  margin: auto;
  width: 80%;
  white-space: normal;
}

.image-title {
  padding: 10px 12px;
  font-size: 14px;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-grow: 1;
}

body.list-view .image-title {
  white-space: normal;
  flex-grow: 1;
}

.item-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 8px 12px;
  margin-top: auto;
  background-color: #f8f9fa;
  border-top: 1px solid #eee;
}

.download-btn,
.copy-link-btn,
.exclusive-btn {
  background-color: rgba(0,0,0,0.6);
  color: white;
  border: none;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  flex-shrink: 0;
  position: relative;
}

.download-btn:hover,
.copy-link-btn:hover,
.exclusive-btn:hover {
  background-color: rgba(0,0,0,0.8);
}

.exclusive-btn.exclusive {
  background-color: #d9534f;
}

.exclusive-btn.exclusive:hover {
  background-color: #c9302c;
}

body.list-view .item-footer {
  margin-left: auto;
  padding: 8px;
  background-color: transparent;
  border-top: none;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 30px 0;
  gap: 5px;
}

.page-btn {
  background-color: #16677c;
  color: white;
  padding: 8px 16px;
  border-radius: 4px;
  text-decoration: none;
  transition: background-color 0.3s;
  font-size: 14px;
}

.page-btn:hover {
  background-color: #0d4555;
}

.page-btn.active {
  background-color: #0d4555;
  font-weight: bold;
}

.page-btn.disabled {
  background-color: #cccccc;
  cursor: not-allowed;
  pointer-events: none;
}

.page-dots {
  padding: 8px 12px;
  color: #333;
}

.warning-message {
  text-align: center;
  color: #d9534f;
  margin: 20px 0;
  font-weight: bold;
}

.tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}

.download-btn:hover .tooltip,
.copy-link-btn:hover .tooltip,
.exclusive-btn:hover .tooltip {
  opacity: 1;
}

.gallery-item iframe {
  border: none;
  min-height: 200px;
  margin-bottom: -4px;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background-color: white;
  border-radius: 12px;
  width: 90%;
  max-width: 1000px;
  max-height: 90vh;
  display: flex;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-preview {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  background-color: #f5f5f5;
  max-height: 80vh;
  overflow: auto;
}

.modal-preview img {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
}

.modal-preview iframe {
  width: 100%;
  height: 80vh;
  border: none;
}

.modal-preview video {
  max-width: 100%;
  max-height: 80vh;
}

.modal-info {
  width: 300px;
  padding: 20px;
  display: flex;
  flex-direction: column;
}

.modal-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 15px;
  word-break: break-all;
}

.modal-description {
  margin-bottom: 20px;
  color: #555;
  line-height: 1.5;
}

.modal-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-bottom: 20px;
}

.modal-tag {
  background-color: #e1f5fe;
  color: #0288d1;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.modal-actions {
  margin-top: auto;
  display: flex;
  gap: 10px;
}

.modal-action-btn {
  flex: 1;
  padding: 10px;
  border-radius: 4px;
  border: none;
  background-color: #16677c;
  color: white;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

.modal-action-btn:hover {
  background-color: #0d4555;
}

.close-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  background-color: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  font-size: 20px;
}

.close-btn:hover {
  background-color: rgba(255, 255, 255, 0.3);
}

.file-date {
  display: block;
  margin-top: 10px;
  color: #777;
  font-size: 12px;
}

.date-group {
  margin: 30px 0 10px;
  padding-bottom: 5px;
  border-bottom: 2px solid #16677c;
  color: #16677c;
  font-weight: bold;
  font-size: 1.2rem;
  grid-column: 1 / -1;
}

body.list-view .date-group {
  margin-left: 20px;
}

.sidebar-toggle {
  position: fixed;
  left: 0;
  top: 20px;
  background: #16677c;
  color: white;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 0 4px 4px 0;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 101;
  transition: all 0.3s ease;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.sidebar.active ~ .sidebar-toggle {
  left: 250px;
}

.sidebar-toggle:hover {
  background: #0d4555;
}

.folder {
  padding: 8px 0;
  cursor: pointer;
  position: relative;
}

.folder-name {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.folder-name:hover {
  background-color: #e9ecef;
}

.folder-icon {
  width: 20px;
  text-align: center;
  transition: transform 0.2s;
}

.folder.active > .folder-name > .folder-icon {
  transform: rotate(90deg);
}

.subfolders {
  padding-left: 20px;
  display: none;
  margin-top: 5px;
}

.folder.active .subfolders {
  display: block;
}

.add-folder-btn, .delete-folder-btn {
  background: none;
  border: none;
  color: #16677c;
  cursor: pointer;
  margin-left: auto;
  font-size: 16px;
  padding: 0 5px;
}

.add-folder-btn {
  color: #16677c;
}

.delete-folder-btn {
  color: #d9534f;
}

.folder:hover .add-folder-btn,
.folder:hover .delete-folder-btn,
.folder.active .add-folder-btn,
.folder.active .delete-folder-btn {
  opacity: 1;
}

.folder-input {
  width: calc(100% - 10px);
  padding: 5px;
  margin: 5px 0;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.delete-folder-btn:hover {
  color: #c9302c;
}

.folder-input:focus {
  outline: none;
  border-color: #16677c;
}

.add-main-folder-btn {
  background-color: #16677c;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  margin: 10px 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  width: 100%;
  justify-content: center;
}

.add-main-folder-btn:hover {
  background-color: #0d4555;
}

.folders-container {
  margin-top: 10px;
  padding: 5px;
}

.folders-container > .folder {
  margin-bottom: 5px;
}

.folder-selector {
  margin-top: 20px;
  padding: 15px;
  background-color: #f5f5f5;
  border-radius: 8px;
}

.folder-selector h4 {
  margin: 0 0 10px 0;
  color: #16677c;
}

.folder-tree {
  max-height: 200px;
  overflow-y: auto;
  padding: 5px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background-color: white;
}

.folder-node {
  margin-bottom: 5px;
}

.folder-header {
  display: flex;
  align-items: center;
  padding: 5px;
  cursor: pointer;
  border-radius: 4px;
}

.folder-header:hover {
  background-color: #e9ecef;
}

.folder-icon {
  margin-right: 8px;
}

.folder-title {
  flex-grow: 1;
}

.select-folder-btn {
  background: none;
  border: none;
  color: #28a745;
  cursor: pointer;
  font-size: 16px;
  padding: 0 5px;
  opacity: 0;
}

.folder-header:hover .select-folder-btn {
  opacity: 1;
}

.subfolders-container {
  padding-left: 20px;
  display: none;
}

.folder-node.active .subfolders-container {
  display: block;
}

.confirm-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.confirm-modal.active {
  opacity: 1;
  visibility: visible;
}

.confirm-content {
  background: white;
  padding: 25px;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.confirm-message {
  margin-bottom: 20px;
  font-size: 16px;
  color: #333;
}

.confirm-checkbox {
  margin: 15px 0;
  display: flex;
  align-items: center;
}

.confirm-checkbox input {
  margin-right: 10px;
}

.confirm-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.confirm-btn {
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  border: none;
  font-weight: 600;
}

.confirm-btn.cancel {
  background: #f0f0f0;
  color: #333;
}

.confirm-btn.proceed {
  background: #d9534f;
  color: white;
}

.confirm-btn.proceed:disabled {
  background: #cccccc;
  cursor: not-allowed;
}

@media (max-width: 768px) {
  header {
    flex-direction: column;
    padding: 15px;
  }

  header h1 {
    font-size: 2rem;
    margin: 10px 0;
  }

  .controls {
    justify-content: center;
    width: 100%;
  }

  .search-bar {
    flex-direction: column;
    padding: 0 15px;
  }

  #fileCount {
    text-align: center;
    margin-top: 10px;
  }

  .gallery {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  }

  body.list-view .gallery-item {
    flex-direction: column;
    align-items: flex-start;
  }

  body.list-view .item-footer {
    margin: 10px 0 0 0;
    align-self: flex-start;
  }

  .pagination {
    flex-wrap: wrap;
  }

  .modal-content {
    flex-direction: column;
    width: 95%;
    max-height: 95vh;
  }

  .modal-preview {
    max-height: 50vh;
  }

  .modal-preview img,
  .modal-preview iframe,
  .modal-preview video {
    max-height: 50vh;
  }

  .modal-info {
    width: auto;
    padding: 15px;
  }

  .modal-actions {
    margin-top: 20px;
  }

  .sidebar {
    width: 280px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  }
  
  .sidebar.active ~ .main-content {
    margin-left: 0;
  }
  
  .sidebar-toggle {
    left: auto;
    right: -40px;
    border-radius: 4px 0 0 4px;
  }
  
  .sidebar.active ~ .sidebar-toggle {
    left: auto;
    right: 10px;
  }
}
  </style>
</head>
<body>

  <header>
    <img src="https://comptestockageapi.blob.core.windows.net/testcanto/01_New_PUR_LOGO_Color.png" alt="Logo PUR" class="logo" />
    <h1>Media Library</h1>
    <div class="controls">
      <a href="https://purprojet.sharepoint.com/sites/AdminToolKit/SitePages/PUR-Admin-ToolKit.aspx" class="back-btn" target="_blank" rel="noopener noreferrer" title="↩ Back to Admin Toolkit"> ↩️ Back to Admin Toolkit</a>
      <button id="ascSortBtn">Sort A-Z</button>
      <button id="descSortBtn">Sort Z-A</button>
      <button id="sortByDateBtn">Sort by Date</button>
      <button id="toggleViewBtn">List View</button>
      <button id="togglePaginationBtn" class="{% if not show_all %}active{% endif %}">
        {% if show_all %}Pagination Mode{% else %}Show All Files{% endif %}
      </button>
      
      <select id="filterSelect" title="Filtrer les fichiers">
        <option value="all">All Files</option>
        <option value="images">Images</option>
        <option value="videos">Videos</option>
        <option value="audio">Audio</option>
        <option value="documents">Documents</option>
        <option value="presentations">Presentations</option>
        <option value="exclusive">Exclusive Files</option>
        <option value="others">Others</option>
      </select>
    </div>
  </header>
  
  <button class="sidebar-toggle" id="sidebarToggle">❯</button>

  <button id="logoutBtn" style="background-color: #ff4d4d; color: white; border: none; border-radius: 25px; padding: 10px 16px; 
      font-weight: 600; cursor: pointer; font-size: 14px; margin-left: 10px;">Log Out</button>
  
  <div class="content-wrapper">
    <div class="sidebar" id="sidebar">
      <button class="add-main-folder-btn" id="addMainFolderBtn">
        + Add New Folder
      </button>
      <div class="folders-container" id="foldersContainer">
        <!-- Les dossiers seront ajoutés ici -->
      </div>
    </div>

    <div class="main-content" id="mainContent">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Find a file..." />
        <div id="fileCount">Showing {{ images|length }} of {{ total_files }} files</div>
      </div>

      {% if show_all %}
      <div class="warning-message">
        Warning: Displaying all files may impact performance with large collections
      </div>
      {% endif %}

      <div class="gallery" id="gallery">
        {% for file in files %}
        <div class="gallery-item" data-tags="{{ file.tags | join(', ') | lower }}" data-name="{{ file.nom|lower }}" data-link="{{ file.lien }}" data-filename="{{ file.nom }}" data-description="{{ file.description }}" data-tags="{{ file.tags|tojson }}" data-exclusive="{{ 'true' if file.is_exclusive is true else 'false' }}" {% if file.date_ajout %}data-date="{{ file.date_ajout.strftime('%d-%m-%Y') }}"{% endif %}>
          {% set ext = file.nom.split('.')[-1]|lower %}

          {% if ext in ['png', 'jpg', 'jpeg', 'gif', 'webp'] %}
            <div class="img-placeholder"></div>
            <img src="{{ file.lien }}" alt="{{ file.nom }}" loading="lazy" />

          {% elif ext in ['heic', 'thm', 'psd', 'docx', 'pptx', 'emf'] %}
            <img src="/static/icons/{{ ext }}.png" alt="{{ file.nom }}" style="max-height: 200px;" loading="lazy" />

          {% elif ext in ['docx', 'pptx'] %}
            <iframe src="https://view.officeapps.live.com/op/view.aspx?src={{ file.lien | url_encode }}"
                    width="100%" height="250px" style="border: none;" loading="lazy" preload="none"></iframe>

          {% elif ext == 'pdf' %}
            <iframe src="{{ file.lien }}" width="100%" height="200px"
                    style="border: 1px solid #ccc; border-radius: 8px;" loading="lazy" preload="none"></iframe>

          {% elif ext == 'emf' %}
            <iframe src="{{ file.lien }}" width="100%" height="200px"
                    style="border: 1px solid #ccc; border-radius: 8px;" loading="lazy"></iframe>

          {% elif ext in ['mp4', 'webm', 'mov'] %}
            <video controls width="100%" style="max-height: 250px; border-radius: 8px;" preload="none">
              <source src="{{ file.lien }}" type="video/{{ ext }}">
              Your browser does not support the video.
            </video>

          {% elif ext in ['mp3', 'wav'] %}
            <audio controls style="width: 100%;" preload="none">
              <source src="{{ file.lien }}" type="audio/{{ ext }}">
              Your browser does not support audio.
            </audio>

          {% else %}
            <div class="file-preview" loading="lazy" style="text-align:center;">
              <img src="/static/No_preview.png" alt="No preview available" style="max-width:150px; max-height:150px;" loading="lazy" />
              <div><small>{{ ext|upper }}</small></div>
            </div>
          {% endif %}

          <div class="image-title">{{ file.nom }}</div>
          <div class="item-footer">
            <button class="copy-link-btn" data-link="{{ file.lien }}">
              <span class="tooltip">Copy The Link</span>🔗
            </button>
            <a href="{{ file.lien }}" class="download-btn" download="{{ file.nom }}">
              <span class="tooltip">Download</span>⬇
            </a>
            <button class="exclusive-btn {% if file.is_exclusive %}exclusive{% endif %}" 
                    data-filename="{{ file.nom }}" 
                    data-exclusive="{{ 'true' if file.is_exclusive else 'false' }}">
              <span class="tooltip">{% if file.is_exclusive %}Exclusive{% else %}Not Exclusive{% endif %}</span>
              {% if file.is_exclusive %}★{% else %}☆{% endif %}
            </button>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if not show_all %}
      <!-- Pagination -->
      <div class="pagination">
        {% if current_page > 1 %}
          <a href="{{ url_for('index', page=current_page-1) }}" class="page-btn">Previous</a>
        {% else %}
          <span class="page-btn disabled">Previous</span>
        {% endif %}

        {% if current_page > 3 %}
          <a href="{{ url_for('index', page=1) }}" class="page-btn">1</a>
          {% if current_page > 4 %}
            <span class="page-dots">...</span>
          {% endif %}
        {% endif %}

        {% for page_num in range([1, current_page-2]|max, [current_page+3, total_pages+1]|min) %}
          <a href="{{ url_for('index', page=page_num) }}" class="page-btn {% if page_num == current_page %}active{% endif %}">
            {{ page_num }}
          </a>
        {% endfor %}

        {% if current_page < total_pages - 2 %}
          {% if current_page < total_pages - 3 %}
            <span class="page-dots">...</span>
          {% endif %}
          <a href="{{ url_for('index', page=total_pages) }}" class="page-btn">{{ total_pages }}</a>
        {% endif %}

        {% if current_page < total_pages %}
          <a href="{{ url_for('index', page=current_page+1) }}" class="page-btn">Next</a>
        {% else %}
          <span class="page-btn disabled">Next</span>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="fileModal">
    <button class="close-btn" id="closeModal">&times;</button>
    <div class="modal-content">
      <div class="modal-preview" id="modalPreview">
        <!-- Preview content will be inserted here -->
      </div>
      <div class="modal-info">
  <div class="modal-title" id="modalTitle"></div>
  <div class="modal-description" id="modalDescription"></div>
  <div class="modal-dates">
    <div><strong>Added on:</strong> <span id="modalAddedDate"></span></div>
    <div><strong>Event Date:</strong> <span id="modalEventDate"></span></div>
  </div>
  <div class="modal-tags" id="modalTags"></div>
  <div class="folder-selector" id="folderSelector" style="margin-top: 15px;">
    <div><strong>Current Folder:</strong> <span id="currentFolderName">None</span></div>
    <button class="modal-action-btn" id="addToFolderBtn" style="margin-top: 10px;">
      <span>Add to Folder</span>
    </button>
    <div class="folder-tree" id="folderTree" style="display: none; max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-action-btn" id="modalCopyBtn">
      <span>Copy Link</span>
    </button>
    <a href="#" class="modal-action-btn" id="modalDownloadBtn" download>
      <span>Download</span>
    </a>
  </div>
</div>
    </div>
  </div>

  <!-- Modal de confirmation pour les fichiers exclusifs -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-content">
      <div class="confirm-message">
        ⚠️ This file is marked as exclusive. Are you sure you want to download it?
      </div>
      <div class="confirm-checkbox">
        <input type="checkbox" id="confirmCheckbox">
        <label for="confirmCheckbox">I confirm I have the rights to download this exclusive file</label>
      </div>
      <div class="confirm-buttons">
        <button class="confirm-btn cancel" id="confirmCancel">Cancel</button>
        <button class="confirm-btn proceed" id="confirmProceed" disabled>Download</button>
      </div>
    </div>
  </div>

  <script>
    // ===========================================
// CONSTANTES ET VARIABLES GLOBALES
// ===========================================
const UPLOAD_SECRET = "superTokenOps2025";
let isListView = false;
let isSortedByDate = false;
let isAuthenticated = false;

// Éléments DOM
const searchInput = document.getElementById("searchInput");
const gallery = document.getElementById("gallery");
const ascSortBtn = document.getElementById("ascSortBtn");
const descSortBtn = document.getElementById("descSortBtn");
const sortByDateBtn = document.getElementById("sortByDateBtn");
const toggleViewBtn = document.getElementById("toggleViewBtn");
const togglePaginationBtn = document.getElementById("togglePaginationBtn");
const filterSelect = document.getElementById("filterSelect");
const fileCount = document.getElementById("fileCount");
const fileModal = document.getElementById("fileModal");
const closeModal = document.getElementById("closeModal");
const modalPreview = document.getElementById("modalPreview");
const modalTitle = document.getElementById("modalTitle");
const modalDescription = document.getElementById("modalDescription");
const modalTags = document.getElementById("modalTags");
const modalCopyBtn = document.getElementById("modalCopyBtn");
const modalDownloadBtn = document.getElementById("modalDownloadBtn");
const modalAddedDate = document.getElementById("modalAddedDate");
const modalEventDate = document.getElementById("modalEventDate");
const confirmModal = document.getElementById('confirmModal');
const confirmCheckbox = document.getElementById('confirmCheckbox');
const confirmProceed = document.getElementById('confirmProceed');
const confirmCancel = document.getElementById('confirmCancel');
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const addMainFolderBtn = document.getElementById('addMainFolderBtn');
const foldersContainer = document.getElementById('foldersContainer');
let currentDownloadLink = null;
let currentModalFilename = null;



// Mappage des types de fichiers
const fileTypeMap = {
  images: ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.svg', '.webp'],
  videos: ['.mp4', '.mov', '.avi', '.wmv', '.flv', '.mkv', '.webm'],
  audio: ['.mp3', '.wav', '.aac', '.flac', '.ogg', '.m4a'],
  documents: ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.txt', '.rtf', '.odt'],
  presentations: ['.ppt', '.pptx', '.key', '.odp']
};

// ===========================================
// FONCTIONS UTILITAIRES
// ===========================================

function getFileExtension(filename) {
  return filename.slice(filename.lastIndexOf('.')).toLowerCase();
}

function formatDateForDisplay(dateString) {
  if (!dateString) return "No date";
  
  if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
    return dateString;
  }
  
  try {
    const [day, month, year] = dateString.split('-');
    return `${day}-${month}-${year}`;
  } catch (e) {
    console.error("Error formatting date:", e);
    return "Invalid date";
  }
}

// ===========================================
// GESTION DES DOSSIERS
// ===========================================

function loadFolders() {
  fetch('/get_folders')
    .then(response => response.json())
    .then(data => {
      renderFolderStructure(data.folders);
    })
    .catch(error => console.error('Error loading folders:', error));
}

function renderFolderStructure(folders) {
  foldersContainer.innerHTML = '';
  
  // Créer un mappage des dossiers
  const folderMap = {};
  folders.forEach(folder => {
    folderMap[folder.id] = {
      ...folder,
      element: null,
      subfolders: []
    };
  });
  
  // Construire la hiérarchie
  Object.values(folderMap).forEach(folder => {
    if (folder.parent_id && folderMap[folder.parent_id]) {
      folderMap[folder.parent_id].subfolders.push(folder);
    }
  });
  
  // Rendre les dossiers racine
  Object.values(folderMap).forEach(folder => {
    if (!folder.parent_id) {
      renderFolder(folder, foldersContainer);
    }
  });
}

function renderFolder(folder, parentElement) {
  const folderElement = document.createElement('div');
  folderElement.className = 'folder';
  folderElement.dataset.folderId = folder.id;
  
  const folderName = document.createElement('div');
  folderName.className = 'folder-name';
  folderName.innerHTML = `
    <span class="folder-icon">📁</span>
    <span class="folder-title">${folder.name}</span>
    <button class="add-folder-btn" title="Add subfolder">+</button>
    <button class="delete-folder-btn" title="Delete folder">×</button>
  `;
  
  const subfolders = document.createElement('div');
  subfolders.className = 'subfolders';
  
  folderElement.appendChild(folderName);
  folderElement.appendChild(subfolders);
  
  // Rendre les sous-dossiers
  folder.subfolders.forEach(subfolder => {
    renderFolder(subfolder, subfolders);
  });
  
  // Gestion des événements
  folderName.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-folder-btn')) {
      e.stopPropagation();
      promptForPassword(() => showFolderInput(subfolders, folder.id));
      return;
    }
    
    if (e.target.classList.contains('delete-folder-btn')) {
      e.stopPropagation();
      promptForPassword(() => {
        if (confirm('Delete this folder and all its contents?')) {
          deleteFolder(folder.id);
        }
      });
      return;
    }
    
    folderElement.classList.toggle('active');
    
    // Filtrer les fichiers
    if (folderElement.classList.contains('active')) {
      filterFilesByFolder(folder.id);
    } else {
      filterAndDisplay();
    }
  });
  
  parentElement.appendChild(folderElement);
  folder.element = folderElement;
}

function showFolderInput(parentElement, parentId = null) {
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'folder-input';
  input.placeholder = 'Enter folder name';
  
  input.addEventListener('keyup', function(e) {
    if (e.key === 'Enter' && this.value.trim()) {
      createFolder(this.value.trim(), parentId);
      this.remove();
    } else if (e.key === 'Escape') {
      this.remove();
    }
  });
  
  input.addEventListener('blur', function() {
    if (this.parentNode) {
      this.remove();
    }
  });
  
  parentElement.appendChild(input);
  input.focus();
}

function createFolder(name, parentId = null) {
  const formData = new FormData();
  formData.append('name', name);
  if (parentId) formData.append('parent_id', parentId);
  
  fetch('/create_folder', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      loadFolders();
    } else {
      alert('Error creating folder: ' + data.message);
    }
  })
  .catch(error => console.error('Error creating folder:', error));
}

function deleteFolder(folderId) {
  const formData = new FormData();
  formData.append('folder_id', folderId);
  
  fetch('/delete_folder', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      loadFolders();
      filterAndDisplay();
    } else {
      alert('Error deleting folder: ' + data.message);
    }
  })
  .catch(error => console.error('Error deleting folder:', error));
}

function filterFilesByFolder(folderId) {
  // D'abord, récupérer tous les fichiers dans ce dossier et ses sous-dossiers
  fetch(`/get_files_in_folder/${folderId}`)
    .then(response => response.json())
    .then(data => {
      const filesInFolder = data.files.map(f => f.name.toLowerCase());
      
      // Maintenant filtrer l'affichage
      const items = gallery.querySelectorAll(".gallery-item");
      items.forEach(item => {
        const itemName = item.getAttribute("data-name").toLowerCase();
        item.style.display = filesInFolder.includes(itemName) ? "block" : "none";
      });
      
      fileCount.textContent = `Showing ${filesInFolder.length} files in folder`;
    })
    .catch(error => {
      console.error('Error filtering files:', error);
    });
}

function updateFileFolder(filename, folderId) {
  const formData = new FormData();
  formData.append('filename', filename);
  if (folderId) formData.append('folder_id', folderId);
  
  fetch('/update_file_folder', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      const item = document.querySelector(`.gallery-item[data-filename="${filename}"]`);
      if (item) {
        item.dataset.folderId = folderId || '';
      }
    } else {
      alert('Error updating folder: ' + data.message);
    }
  })
  .catch(error => console.error('Error:', error));
}

// ===========================================
// GESTION DES FICHIERS
// ===========================================

function filterAndDisplay() {
  const searchValue = searchInput.value.toLowerCase();
  const filterValue = filterSelect.value;
  let visibleCount = 0;

  const items = gallery.querySelectorAll(".gallery-item");
  items.forEach(item => {
    const name = item.getAttribute("data-name").toLowerCase();
    const tags = item.getAttribute("data-tags")?.toLowerCase() || "";
    const ext = getFileExtension(name);
    const isExclusive = item.getAttribute("data-exclusive") === 'true';

    let show = name.includes(searchValue) || tags.includes(searchValue);

    if (show) {
      if (filterValue === 'all') {
        show = true;
      } else if (filterValue === 'exclusive') {
        show = isExclusive === true || isExclusive === 'true';
      } else if (filterValue === 'others') {
        const allExts = [].concat(...Object.values(fileTypeMap));
        show = !allExts.includes(ext);
      } else {
        show = fileTypeMap[filterValue]?.includes(ext) || false;
      }
    }

    item.style.display = show ? "block" : "none";
    if (show) visibleCount++;
  });

  fileCount.textContent = `Showing ${visibleCount} of {{ total_files }} files`;
  lazyLoadImages();
}

function sortGallery(asc = true) {
  const items = Array.from(gallery.children).filter(item => item.classList.contains('gallery-item'));
  items.sort((a, b) => {
    const nameA = a.getAttribute("data-name");
    const nameB = b.getAttribute("data-name");
    return asc ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
  });
  
  items.forEach(item => gallery.appendChild(item));
  filterAndDisplay();
}

function groupFilesByDate() {
  const gallery = document.getElementById("gallery");
  const items = Array.from(gallery.querySelectorAll(".gallery-item"));
  
  const filesByDate = {};
  
  items.forEach(item => {
    const date = item.getAttribute("data-date");
    if (!date) return;
    
    if (!/^\d{2}-\d{2}-\d{4}$/.test(date)) {
      console.warn("Invalid date format:", date);
      return;
    }
    
    if (!filesByDate[date]) {
      filesByDate[date] = [];
    }
    filesByDate[date].push(item);
  });
  
  const sortedDates = Object.keys(filesByDate).sort((a, b) => {
    const [dayA, monthA, yearA] = a.split('-').map(Number);
    const [dayB, monthB, yearB] = b.split('-').map(Number);
    const dateA = new Date(yearA, monthA - 1, dayA);
    const dateB = new Date(yearB, monthB - 1, dayB);
    return dateB - dateA;
  });
  
  gallery.innerHTML = '';
  
  sortedDates.forEach(date => {
    const dateHeader = document.createElement("div");
    dateHeader.className = "date-group";
    dateHeader.textContent = date;
    gallery.appendChild(dateHeader);
    
    filesByDate[date].forEach(item => {
      gallery.appendChild(item);
    });
  });
}

function lazyLoadImages() {
  const lazyImages = document.querySelectorAll('img[loading="lazy"]');
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        const placeholder = img.previousElementSibling;
        
        img.onload = function() {
          img.setAttribute('data-loaded', 'true');
          if (placeholder && placeholder.classList.contains('img-placeholder')) {
            placeholder.style.display = 'none';
          }
        };
        
        if (!img.src || img.src !== img.dataset.src) {
          img.src = img.dataset.src || img.getAttribute('src');
        }
        
        observer.unobserve(img);
      }
    });
  }, {
    rootMargin: '50px 0px',
    threshold: 0.01
  });

  lazyImages.forEach(img => {
    if (!img.dataset.src) {
      img.dataset.src = img.getAttribute('src');
      img.removeAttribute('src');
    }
    observer.observe(img);
  });
}

// ===========================================
// GESTION DES MODALS
// ===========================================

function showFileModal(item) {
  currentModalFilename = item.getAttribute('data-filename');
  const filename = currentModalFilename;
  const link = item.getAttribute('data-link');
  const ext = getFileExtension(filename);
  const currentFolderId = item.dataset.folderId || '';
  
  modalTitle.textContent = filename;
  modalDownloadBtn.href = `/download?url=${encodeURIComponent(link)}&filename=${filename}`;
  
  // Charger les détails du fichier
  fetch(`/file_details?filename=${encodeURIComponent(filename)}`)
    .then(response => response.json())
    .then(data => {
      const descriptionHTML = data.description 
          ? `<p>${data.description}</p>`
          : "<p>No description available</p>";

      modalDescription.innerHTML = descriptionHTML;
      modalAddedDate.textContent = data.date_ajout || "Unknown";
      modalEventDate.textContent = data.date_event || "Not specified";

      if (data.tags && data.tags.length > 0) {
          modalTags.innerHTML = data.tags.map(tag => 
              `<span class="modal-tag">${tag}</span>`
          ).join('');
      } else {
          modalTags.innerHTML = "<span class='modal-tag'>No tags</span>";
      }

      if (data.is_exclusive) {
          modalTags.innerHTML += `<span class="modal-tag" style="background-color:#d9534f;color:white;">★ Exclusive</span>`;
      }
      
      // Afficher le dossier actuel
      document.getElementById('currentFolderName').textContent = data.folder_id 
          ? `Loading...` 
          : "None";
      
      // Charger la structure des dossiers
      loadFoldersForModal(data.folder_id);
    })
    .catch(error => {
      console.error('Error fetching file details:', error);
      modalDescription.innerHTML = "<p>Error loading details</p>";
      modalTags.innerHTML = "<span class='modal-tag'>Error</span>";
    });
  
  // Afficher le preview
  let previewContent = '';
  
  if (fileTypeMap.images.includes(ext)) {
      previewContent = `<img src="${link}" alt="${filename}" />`;
  } else if (fileTypeMap.videos.includes(ext)) {
      previewContent = `<video controls autoplay style="width:100%; max-height:80vh;">
                        <source src="${link}" type="video/${ext.slice(1)}">
                        Your browser does not support the video.
                      </video>`;
  } else if (fileTypeMap.audio.includes(ext)) {
      previewContent = `<audio controls autoplay style="width:100%;">
                        <source src="${link}" type="audio/${ext.slice(1)}">
                        Your browser does not support audio.
                      </audio>`;
  } else if (ext === '.pdf') {
      previewContent = `<iframe src="${link}" width="100%" height="100%" style="border:none;"></iframe>`;
  } else if (['.docx', '.pptx'].includes(ext)) {
      previewContent = `<iframe src="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(link)}" 
                            width="100%" height="100%" style="border:none;"></iframe>`;
  } else {
      previewContent = `<div class="file-preview" style="width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        <div style="font-size:24px; margin-bottom:10px;">${ext.toUpperCase()}</div>
                        <div>Preview not available</div>
                      </div>`;
  }
  
  modalPreview.innerHTML = previewContent;
  fileModal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function loadFoldersForModal(currentFolderId) {
  fetch('/get_folders')
    .then(response => response.json())
    .then(data => {
      const folderTree = document.getElementById('folderTree');
      folderTree.innerHTML = '';
      
      // Afficher le nom du dossier actuel
      if (currentFolderId) {
        const currentFolder = data.folders.find(f => f.id == currentFolderId);
        document.getElementById('currentFolderName').textContent = currentFolder 
            ? currentFolder.name 
            : "Unknown";
      } else {
        document.getElementById('currentFolderName').textContent = "None";
      }
      
      // Créer un mappage des dossiers
      const folderMap = {};
      data.folders.forEach(folder => {
        folderMap[folder.id] = {
          ...folder,
          element: null,
          subfolders: []
        };
      });
      
      // Construire la hiérarchie
      Object.values(folderMap).forEach(folder => {
        if (folder.parent_id && folderMap[folder.parent_id]) {
          folderMap[folder.parent_id].subfolders.push(folder);
        }
      });
      
      // Rendre les dossiers racine
      Object.values(folderMap).forEach(folder => {
        if (!folder.parent_id) {
          renderFolderNode(folder, folderTree, currentFolderId);
        }
      });
    });
}

function renderFolderNode(folder, parentElement, currentFolderId) {
  const folderElement = document.createElement('div');
  folderElement.className = 'folder-node';
  folderElement.dataset.folderId = folder.id;
  
  const folderHeader = document.createElement('div');
  folderHeader.className = 'folder-header';
  folderHeader.innerHTML = `
    <span class="folder-icon">${folder.subfolders.length > 0 ? '📁' : '📄'}</span>
    <span class="folder-title">${folder.name}</span>
    <button class="select-folder-btn" title="Select this folder">✓</button>
  `;
  
  const subfoldersContainer = document.createElement('div');
  subfoldersContainer.className = 'subfolders-container';
  
  folderElement.appendChild(folderHeader);
  folderElement.appendChild(subfoldersContainer);
  
  // Rendre les sous-dossiers
  folder.subfolders.forEach(subfolder => {
    renderFolderNode(subfolder, subfoldersContainer, currentFolderId);
  });
  
  // Gestion des événements
  folderHeader.addEventListener('click', function(e) {
    if (e.target.classList.contains('select-folder-btn')) {
      e.stopPropagation();
      updateFileFolder(currentModalFilename, folder.id);
      document.getElementById('currentFolderName').textContent = folder.name;
      
      // Fermer l'arborescence après sélection
      document.getElementById('folderTree').style.display = 'none';
      return;
    }
    
    // Toggle pour afficher/masquer les sous-dossiers
    const wasActive = folderElement.classList.contains('active');
    document.querySelectorAll('.folder-node').forEach(node => {
      node.classList.remove('active');
    });
    
    if (!wasActive) {
      folderElement.classList.add('active');
    }
  });
  
  parentElement.appendChild(folderElement);
}

function closeFileModal() {
  fileModal.classList.remove('active');
  document.body.style.overflow = '';
  
  const videos = modalPreview.querySelectorAll('video');
  const audios = modalPreview.querySelectorAll('audio');
  
  videos.forEach(video => {
    video.pause();
    video.currentTime = 0;
  });
  
  audios.forEach(audio => {
    audio.pause();
    audio.currentTime = 0;
  });
}

// ===========================================
// GESTION DES ÉVÉNEMENTS
// ===========================================

function setupEventListeners() {
  // Barre de recherche et filtres
  searchInput.addEventListener("input", filterAndDisplay);
  filterSelect.addEventListener("change", filterAndDisplay);
  
  // Boutons de tri
  ascSortBtn.addEventListener("click", () => sortGallery(true));
  descSortBtn.addEventListener("click", () => sortGallery(false));
  sortByDateBtn.addEventListener("click", function() {
    isSortedByDate = !isSortedByDate;
    this.classList.toggle("active", isSortedByDate);
    
    if (isSortedByDate) {
      groupFilesByDate();
    } else {
      filterAndDisplay();
    }
  });
  
  // Boutons d'affichage
  toggleViewBtn.addEventListener("click", () => {
    isListView = !isListView;
    document.body.classList.toggle("list-view", isListView);
    toggleViewBtn.textContent = isListView ? "Gallery View" : "List View";
    lazyLoadImages();
  });
  
  togglePaginationBtn.addEventListener("click", () => {
    const currentUrl = new URL(window.location.href);
    const showAll = currentUrl.searchParams.get("show_all") === "true";
    
    if (showAll) {
      currentUrl.searchParams.delete("show_all");
      currentUrl.searchParams.delete("page");
    } else {
      currentUrl.searchParams.set("show_all", "true");
    }
    
    window.location.href = currentUrl.toString();
  });
  
  // Boutons de copie et téléchargement
  setupCopyLinkButtons();
  setupExclusiveButtons();
  setupGalleryItemClicks();
  
  // Modal de confirmation
  confirmCheckbox.addEventListener('change', function() {
    confirmProceed.disabled = !this.checked;
  });
  
  confirmProceed.addEventListener('click', function() {
    if (currentDownloadLink) {
      const a = document.createElement('a');
      a.href = currentDownloadLink;
      a.download = currentDownloadLink.split('filename=')[1] || 'download';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      confirmModal.classList.remove('active');
      confirmCheckbox.checked = false;
      confirmProceed.disabled = true;
      currentDownloadLink = null;
    }
  });
  
  confirmCancel.addEventListener('click', function() {
    confirmModal.classList.remove('active');
    confirmCheckbox.checked = false;
    confirmProceed.disabled = true;
    currentDownloadLink = null;
  });
  
  confirmModal.addEventListener('click', function(e) {
    if (e.target === confirmModal) {
      confirmModal.classList.remove('active');
      confirmCheckbox.checked = false;
      confirmProceed.disabled = true;
      currentDownloadLink = null;
    }
  });

  document.addEventListener('click', function(e) {
    if (e.target.closest('.download-btn') || e.target.closest('#modalDownloadBtn')) {
      e.preventDefault();
      
      const downloadBtn = e.target.closest('.download-btn') || e.target.closest('#modalDownloadBtn');
      const isExclusive = downloadBtn.closest('.gallery-item')?.getAttribute('data-exclusive') === 'true';
      
      if (isExclusive) {
        currentDownloadLink = downloadBtn.href;
        confirmModal.classList.add('active');
      } else {
        // Téléchargement normal pour les fichiers non exclusifs
        const a = document.createElement('a');
        a.href = downloadBtn.href;
        a.download = downloadBtn.download || 'download';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }
  });
  
  // Sidebar
  sidebarToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    sidebar.classList.toggle('active');
    this.innerHTML = sidebar.classList.contains('active') ? '❮' : '❯';
  });
  
  document.addEventListener('click', function(e) {
    if (window.innerWidth < 992 && 
    !sidebar.contains(e.target) && 
    e.target !== sidebarToggle) {
      sidebar.classList.remove('active');
      sidebarToggle.innerHTML = '❯';
    }
  });
  
  // Bouton d'ajout de dossier principal
  addMainFolderBtn.addEventListener('click', function() {
    promptForPassword(() => {
      showFolderInput(foldersContainer);
    });
  });
  
  // Gestion du logout
  document.getElementById('logoutBtn').addEventListener('click', function() {
    window.location.href = '/logout';
  });
  closeModal.addEventListener('click', closeFileModal);
  fileModal.addEventListener('click', function(e) {
  if (e.target === fileModal) {
    closeFileModal();
  }
});
// Bouton "Add to Folder"
  document.getElementById('addToFolderBtn').addEventListener('click', function() {
  promptForPassword(() => {
    const folderTree = document.getElementById('folderTree');
    folderTree.style.display = folderTree.style.display === 'none' ? 'block' : 'none';
  });
});
}

function setupCopyLinkButtons() {
  const copyButtons = document.querySelectorAll('.copy-link-btn');
  copyButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const link = button.getAttribute('data-link');
      navigator.clipboard.writeText(link)
        .then(() => {
          const tooltip = button.querySelector('.tooltip');
          if (tooltip) {
            tooltip.textContent = 'Link copied!';
            setTimeout(() => {
              tooltip.textContent = 'Copy The Link';
            }, 2000);
          }
        })
        .catch(err => {
          console.error('Erreur lors de la copie: ', err);
        });
    });
  });
}

function setupExclusiveButtons() {
  const exclusiveButtons = document.querySelectorAll('.exclusive-btn');
  exclusiveButtons.forEach(button => {
    const isExclusive = button.getAttribute('data-exclusive') === 'true';
    button.addEventListener('click', async (e) => {
      e.stopPropagation();
      const filename = button.getAttribute('data-filename');
      
      try {
        const response = await fetch(`/update_exclusive?token=${UPLOAD_SECRET}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `filename=${encodeURIComponent(filename)}&is_exclusive=${!isExclusive}`
        });
        
        if (response.ok) {
          const data = await response.json();
          button.setAttribute('data-exclusive', data.is_exclusive.toString());
          button.classList.toggle('exclusive', data.is_exclusive);
          button.innerHTML = `<span class="tooltip">${data.is_exclusive ? 'Exclusive' : 'Not Exclusive'}</span>${data.is_exclusive ? '★' : '☆'}`;
          
          const galleryItem = button.closest('.gallery-item');
          if (galleryItem) {
            galleryItem.setAttribute('data-exclusive', data.is_exclusive.toString());
          }
        } else {
          console.error('Failed to update exclusive status');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });
  });
}

function setupGalleryItemClicks() {
  const items = document.querySelectorAll('.gallery-item');
  items.forEach(item => {
    item.addEventListener('click', (e) => {
      if (e.target.closest('.copy-link-btn') || 
          e.target.closest('.download-btn') || 
          e.target.closest('.exclusive-btn')) {
        return;
      }
      showFileModal(item);
    });
  });
}

// ===========================================
// AUTHENTIFICATION
// ===========================================

function promptForPassword(actionCallback) {
  if (isAuthenticated) {
    actionCallback();
    return;
  }

  const passwordModal = document.createElement('div');
  passwordModal.style.position = 'fixed';
  passwordModal.style.top = '0';
  passwordModal.style.left = '0';
  passwordModal.style.right = '0';
  passwordModal.style.bottom = '0';
  passwordModal.style.backgroundColor = 'rgba(0,0,0,0.7)';
  passwordModal.style.display = 'flex';
  passwordModal.style.justifyContent = 'center';
  passwordModal.style.alignItems = 'center';
  passwordModal.style.zIndex = '2001';
  
  const passwordContent = document.createElement('div');
  passwordContent.style.backgroundColor = 'white';
  passwordContent.style.padding = '20px';
  passwordContent.style.borderRadius = '8px';
  passwordContent.style.width = '300px';
  
  const passwordLabel = document.createElement('label');
  passwordLabel.textContent = 'Admin Password:';
  passwordLabel.style.display = 'block';
  passwordLabel.style.marginBottom = '10px';
  
  const passwordInput = document.createElement('input');
  passwordInput.type = 'password';
  passwordInput.style.width = '100%';
  passwordInput.style.padding = '8px';
  passwordInput.style.marginBottom = '15px';
  passwordInput.style.border = '1px solid #ccc';
  passwordInput.style.borderRadius = '4px';
  
  const buttonContainer = document.createElement('div');
  buttonContainer.style.display = 'flex';
  buttonContainer.style.justifyContent = 'flex-end';
  buttonContainer.style.gap = '10px';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style.padding = '8px 16px';
  cancelBtn.style.border = 'none';
  cancelBtn.style.borderRadius = '4px';
  cancelBtn.style.backgroundColor = '#f0f0f0';
  cancelBtn.style.cursor = 'pointer';
  
  const submitBtn = document.createElement('button');
  submitBtn.textContent = 'Submit';
  submitBtn.style.padding = '8px 16px';
  submitBtn.style.border = 'none';
  submitBtn.style.borderRadius = '4px';
  submitBtn.style.backgroundColor = '#16677c';
  submitBtn.style.color = 'white';
  submitBtn.style.cursor = 'pointer';
  
  cancelBtn.addEventListener('click', () => {
    document.body.removeChild(passwordModal);
  });
  
  submitBtn.addEventListener('click', () => {
    if (passwordInput.value === UPLOAD_SECRET) {
      isAuthenticated = true;
      document.body.removeChild(passwordModal);
      actionCallback();
    } else {
      alert('Incorrect password. You don\'t have permission to perform this action.');
      document.body.removeChild(passwordModal);
    }
  });
  
  passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      submitBtn.click();
    }
  });
  
  buttonContainer.appendChild(cancelBtn);
  buttonContainer.appendChild(submitBtn);
  
  passwordContent.appendChild(passwordLabel);
  passwordContent.appendChild(passwordInput);
  passwordContent.appendChild(buttonContainer);
  passwordModal.appendChild(passwordContent);
  
  document.body.appendChild(passwordModal);
  passwordInput.focus();
}

// ===========================================
// INITIALISATION
// ===========================================

document.addEventListener('DOMContentLoaded', function() {
  setupEventListeners();
  filterAndDisplay();
  lazyLoadImages();
  loadFolders();
  
  // Gestion responsive du sidebar
  function handleSidebarOnResize() {
    if (window.innerWidth >= 992) {
      sidebar.classList.add('active');
      sidebarToggle.innerHTML = '❮';
    } else {
      sidebar.classList.remove('active');
      sidebarToggle.innerHTML = '❯';
    }
  }
  
  window.addEventListener('load', handleSidebarOnResize);
  window.addEventListener('resize', handleSidebarOnResize);
});
  </script>
</body>
</html>